# 可扩展性MySQL

简要的说，可扩展性表明了当**需要增加资源以执行更多工作时**系统能够获得划算的等同提升的能力。缺乏扩展能力的系统在达到收益递减的转折点后将无法进一步增长。

在讨论 MySQL扩展之前，我们先了解关于扩展的几个概念。

- **垂直扩展** 购买更强悍的机器
- **水平扩展** 把任务分配到多台机器上
- **向内扩展** 把一些很少或者不需要的数据进行清理或归档

对于MySQL而言，垂直扩展的天花板对于很多应用都是达不到的。但是对于大型应用垂直扩展性价比太低，我们都知道越高配置的机器价格越恐怖，并且如果我们采用复制的架构一般是不太可能配置出一套能跟得上主库的强大备库。

所以，在短期内通过垂直扩展是没有问题的，但是长期来看最终还是会需要水平扩展。在MySQL的架构限制中，我们都知道主-备的模型更简单可维护，所以想要水平扩展我们可以考虑两个点：**按照功能拆分**、**数据分片** 。

## 1. 按照功能拆分

按照现在盛行的微服务架构体系，按照功能拆分我们可以理解为一个业务服务一个库，按照业务的领域进行划分库的范围。

## 2. 数据分片

数据分片我们可以理解为某一个高频的业务服务的业务领域中某一些点可以进行分片，例如地域、ID。

## 3. 负载均衡

负载均衡的常见目的就是可扩展性、按需路由性、可用性、客户端侧透明性、一致性。

在MySQL的架构中，负载均衡往往是起到了对读库读取的策略(对于客户端透明，按照策略读取不同的主库)

### 3.1 直接连接

#### 3.1.1 复制上的读写分离

由于备库复制是异步的，因此难点是如果处理备库延时导致的脏数据(旧数据)，我们一般是备库只作为只读，而主库作为读和写(主库赋予读的能力是为了兼容应用某些需求需要即时的数据)。

首先我们来看下常见的读写分离方法

- **基于查询分离**

  常规做法，不能容忍脏数据的读写都分配到主库，其他读查询分配到备库

- **基于脏数据分离**

  上面的方式的一种变种，在此基础上让应用检查复制延迟。

- **基于会话分离**

  基于用户会话分离，对于当前用户更新过的暂时去读取主库(通过标记标识是否已更新)，这个也是一种常用的策略。

- **基于版本分离**

  和上面的会话分离相似，不过是通过版本号/时间戳来判断数据是否足够新，如果太旧就从主库读取。

- **基于全局版本/会话分离**

  在每次应用执行写的时候，提交事务后都执行一次 `show master status` 操作，然后在缓存中存储出库日志坐标作为版本号，当应用连接备库时候执行 `show slave status` 操作对比缓存的版本号，如果比主库缓存的新则走备库。

#### 3.1.2 修改应用的配置

采用配置的方式(代码、配置文件、引入配置中心等)

#### 3.2.3 修改DNS名

应用写的是DNS的名，如果备库跟得上主库就把DNS名指向备库，否则指向主库

缺点是DNS修改并不是立即生效，传播到整个网络需要时间。

#### 3.2.4 转移 IP 地址

通过增加一层虚拟IP来转移服务，可以无需重新配置应用

## 4. 总结

可以发展扩展 MySQL 的方式有很多，我们要根据自己的业务场景以及对未来增长做好预先的规划来选取合适的扩展方式。

