# 复制

本文的复制指的是通过网络连接的多台机器上保留相同数据的副本。

在数据发生变更时，我们讨论如下三种流行的变更复制算法。



## 1. 单领导者

副本之一指定为领导者，客户端写入时请求发给领导者，领导者负责存储，并把数据变更发给其他副本(只读副本)

![](http://qiniu.itliusir.com/ddia_replica1.png)

### 1.1 故障转移

#### 从库失效

从库从日志中知道，在发生故障之前处理的最后一个事务，然后请求主库获取失效之前的所有数据变更，慢慢追赶主库直到一致。

#### 主库失效

主库挂掉首先要重新配置所有的客户端，把配置的主库改为新的地址

> 需要注意的是，如果设置的是异步复制，可能会丢一部分故障时期的写入请求，这个情况是非常危险的！



### 1.2 复制日志

#### 基于语句的复制

主库记录下它执行的每个写入语句，并把语句发给其他从库。这种情况可能会造成太多的异常点一般不会采用(非确定的函数、自增的列等各种副作用)

#### WAL(Write Ahead Log)

修改之前先写入 WAL，并把该日志发给从库，从库根据日志来构建一样的数据

#### 逻辑日志复制(基于行)

关系数据库的逻辑日志通常是以行的粒度描述对数据库表的写入的记录序列：

- 对于插入的行，日志包含所有列的新值。
- 对于删除的行，日志包含足够的信息来唯一标识已删除的行。通常是主键，但是如果表上没有主键，则需要记录所有列的旧值。
- 对于更新的行，日志包含足够的信息来唯一标识更新的行，以及所有列的新值（或至少所有已更改的列的新值）。





## 2. 多领导者

在多个不同数据中心，可以使用多领导者配置，每个数据中心的主库都会将其更改复制到其他数据中心的主库中。

![](http://qiniu.itliusir.com/ddia_replica2.png)

这样的架构可以发现故障容忍度更高，但是需要解决的异常问题也更多(写冲突、网络问题带来的性能)

> 例如我们可以通过确保特定用户的请求始终路由到同一数据中心来避免大多的冲突

## 3. 无领导者

Amazon 的 Dynamo 系统采用的就是一种无领导者的设计，其客户端对多个副本同时写入满足过半后认为写入成功，而读取时候同样读取所有的副本取最新的。

而对于系统中短暂不一致的情况，客户端会在读取的时候对旧值的节点进行补偿写入，当然也有一些后台补偿节点在运行。

![](http://qiniu.itliusir.com/ddia_replica3.png)

